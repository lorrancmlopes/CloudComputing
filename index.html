
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.14">
    
    
      
        <title>Projeto: Computação em Nuvem - 2023.1</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.85bb2934.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.a6bdf11c.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="pink">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#roteiro-projeto-final-com-o-tema-aws-rds" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="Projeto: Computação em Nuvem - 2023.1" class="md-header__button md-logo" aria-label="Projeto: Computação em Nuvem - 2023.1" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Projeto: Computação em Nuvem - 2023.1
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Home
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="Projeto: Computação em Nuvem - 2023.1" class="md-nav__button md-logo" aria-label="Projeto: Computação em Nuvem - 2023.1" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Projeto: Computação em Nuvem - 2023.1
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Home
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="." class="md-nav__link md-nav__link--active">
        Home
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pre-requisitos" class="md-nav__link">
    Pré-requisitos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#motivacao" class="md-nav__link">
    Motivação
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aws" class="md-nav__link">
    AWS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rds" class="md-nav__link">
    RDS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#funcoes-aws-lambda" class="md-nav__link">
    Funções AWS Lambda
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aws-sqs" class="md-nav__link">
    AWS SQS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#amazon-simple-notification-service-sns" class="md-nav__link">
    Amazon Simple Notification Service (SNS)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#amazon-cloudwatch" class="md-nav__link">
    Amazon CloudWatch
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iniciando-nossa-infraestrutura" class="md-nav__link">
    Iniciando nossa infraestrutura
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testando-e-monitorando-a-infraestrutura" class="md-nav__link">
    Testando e monitorando a infraestrutura
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#excluindo-a-infraestrutura" class="md-nav__link">
    Excluindo a infraestrutura
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referências
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pre-requisitos" class="md-nav__link">
    Pré-requisitos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#motivacao" class="md-nav__link">
    Motivação
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aws" class="md-nav__link">
    AWS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rds" class="md-nav__link">
    RDS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#funcoes-aws-lambda" class="md-nav__link">
    Funções AWS Lambda
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aws-sqs" class="md-nav__link">
    AWS SQS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#amazon-simple-notification-service-sns" class="md-nav__link">
    Amazon Simple Notification Service (SNS)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#amazon-cloudwatch" class="md-nav__link">
    Amazon CloudWatch
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iniciando-nossa-infraestrutura" class="md-nav__link">
    Iniciando nossa infraestrutura
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testando-e-monitorando-a-infraestrutura" class="md-nav__link">
    Testando e monitorando a infraestrutura
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#excluindo-a-infraestrutura" class="md-nav__link">
    Excluindo a infraestrutura
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referências
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="roteiro-projeto-final-com-o-tema-aws-rds"><strong>Roteiro: Projeto Final com o tema AWS RDS</strong><a class="headerlink" href="#roteiro-projeto-final-com-o-tema-aws-rds" title="Permanent link">&para;</a></h1>
<ul>
<li><strong>Aluno:</strong> Lorran Caetano Machado Lopes</li>
<li><strong>Curso:</strong> Engenharia da Computação</li>
<li><strong>Semestre:</strong> 6</li>
<li><strong>Contato:</strong> <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#108;&#111;&#114;&#114;&#97;&#110;&#99;&#109;&#108;&#64;&#97;&#108;&#46;&#105;&#110;&#115;&#112;&#101;&#114;&#46;&#101;&#100;&#117;&#46;&#98;&#114;">&#108;&#111;&#114;&#114;&#97;&#110;&#99;&#109;&#108;&#64;&#97;&#108;&#46;&#105;&#110;&#115;&#112;&#101;&#114;&#46;&#101;&#100;&#117;&#46;&#98;&#114;</a></li>
<li><strong>Ano:</strong> 2023</li>
</ul>
<h2 id="pre-requisitos">Pré-requisitos<a class="headerlink" href="#pre-requisitos" title="Permanent link">&para;</a></h2>
<p>Para seguir esse tutorial é necessário:</p>
<ul>
<li><strong>Ubuntu &gt; 20.0 ou WSL2</strong></li>
<li><strong>Conta da AWS:</strong>  uma conta com permissões de administrador.</li>
<li><strong>Terraform</strong> </li>
</ul>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Você pode se cadastrar em uma conta da AWS aqui:</p>
<ul>
<li><a href="http://portal.aws.amazon.com/billing/signup">http://portal.aws.amazon.com/billing/signup</a></li>
</ul>
<p>Caso não tenha o Terraform instalado em sua máquina, você pode obtê-lo aqui:</p>
<ul>
<li><a href="https://developer.hashicorp.com/terraform/downloads">https://developer.hashicorp.com/terraform/downloads</a></li>
</ul>
</div>
<h2 id="motivacao">Motivação<a class="headerlink" href="#motivacao" title="Permanent link">&para;</a></h2>
<p>Ao concluir esse roteiro, teremos provisionado uma arquitetura que contem uma função Lambda que grava dados em um dos dois banco de dados do Amazon RDS (clientes ou produtos), por meio da leitura de dados de uma fila do Amazon SQS sempre que uma mensagem é adicionada. 
Ao usar o Lambda para acessar seu banco de dados, você pode ler e gravar dados em resposta a eventos. Sua função e instância de banco de dados também se escalam automaticamente para atender a períodos de alta demanda. Além disso, será enviado um e-mail para um endereço definido a fim de notificar quando o banco de dados for alterado.</p>
<h2 id="_1"><img alt="" src="diagrama.png" /><a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<h2 id="aws">AWS<a class="headerlink" href="#aws" title="Permanent link">&para;</a></h2>
<p>A Amazon Web Services (AWS) é a plataforma de nuvem mais adotada e mais abrangente do mundo, oferecendo mais de 200 serviços completos de datacenters em todo o mundo. Milhões de clientes, incluindo as startups que crescem mais rápido, as maiores empresas e os maiores órgãos governamentais, estão usando a AWS para reduzir custos, ganhar agilidade e inovar mais rapidamente.</p>
<p>Para conseguir interagir com os serviços e funções que a AWS provém, por meio de IaC (Infrastructure as Code), é necessário obter <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html">chaves de acesso</a>, que permitam o gerenciamento e provisionamento dos recursos que desejamos alocar na nuvem.</p>
<p>Guarde a chave de acesso para criar variáveis de ambiente antes de iniciar o Terraform, na fase final do roteiro.</p>
<h2 id="rds">RDS<a class="headerlink" href="#rds" title="Permanent link">&para;</a></h2>
<p>O Amazon RDS (Relational Database Service) é um serviço de banco de dados gerenciado da AWS que permite criar e gerenciar bancos de dados relacionais, como MySQL, PostgreSQL, Oracle, SQL Server, entre outros.
O RDS gerencia tarefas como provisionamento de hardware, instalação de software, backup e recuperação, bem como monitoramento e dimensionamento automático.</p>
<h2 id="funcoes-aws-lambda">Funções AWS Lambda<a class="headerlink" href="#funcoes-aws-lambda" title="Permanent link">&para;</a></h2>
<p>O AWS Lambda é um serviço de computação sem servidor e orientado a eventos que permite executar código para praticamente qualquer tipo de aplicação ou serviço de backend sem provisionar ou gerenciar servidores. É possível acionar o Lambda a partir de mais de 200 serviços da AWS e aplicações de software como serviço (SaaS).
Nesse roteiro, você irá usar o Lambda para abrir uma conexão com uma instância de banco de dados do Amazon RDS e para realizar operações de criação e leitura em um banco de dados do Amazon RDS.</p>
<h2 id="aws-sqs">AWS SQS<a class="headerlink" href="#aws-sqs" title="Permanent link">&para;</a></h2>
<p>O Amazon Simple Queue Service (AWS SQS) é um serviço de mensagens gerenciadas pela Amazon Web Services (AWS) que permite que diferentes componentes de um sistema se comuniquem entre si de forma assíncrona. Ele funciona como uma fila virtual, onde as mensagens são armazenadas até que sejam processadas pelos consumidores. O SQS garante a entrega das mensagens, mesmo em situações de alta demanda ou falhas temporárias, tornando-o uma solução escalável e confiável para sistemas distribuídos.</p>
<h2 id="amazon-simple-notification-service-sns">Amazon Simple Notification Service (SNS)<a class="headerlink" href="#amazon-simple-notification-service-sns" title="Permanent link">&para;</a></h2>
<p>O SNS é um serviço de mensagens e notificação da AWS que permite enviar mensagens para diferentes tipos de endpoints como emails, mensagens de texto(SMS), URLs entre outros. Além disso, você pode configurar o acesso para quem pode publicar e para quem pode se inscrever no tópico.</p>
<h2 id="amazon-cloudwatch">Amazon CloudWatch<a class="headerlink" href="#amazon-cloudwatch" title="Permanent link">&para;</a></h2>
<p>O Amazon CloudWatch é um serviço de monitoramento e observabilidade oferecido pela Amazon Web Services (AWS). Ele permite que você colete, monitore e analise métricas, logs e eventos gerados pelos recursos e aplicativos em execução na AWS. O CloudWatch oferece uma visão abrangente do desempenho e saúde dos seus sistemas, permitindo que você identifique problemas, tome decisões baseadas em dados e tome ações corretivas.</p>
<h2 id="iniciando-nossa-infraestrutura">Iniciando nossa infraestrutura<a class="headerlink" href="#iniciando-nossa-infraestrutura" title="Permanent link">&para;</a></h2>
<p>Crie uma pasta para organizar nossos arquivos chamada <strong>terraform</strong>:</p>
<div class="highlight"><pre><span></span><code>mkdir terraform 
cd terraform
</code></pre></div>
<p>Crie também um arquivo <strong>main.tf</strong>. Nele, criaremos todos os nossos <a href="https://developer.hashicorp.com/terraform/language/resources">recursos</a>.</p>
<div class="highlight"><pre><span></span><code>touch main.tf
</code></pre></div>
<p>Primeiramente, iremos criar duas instâncias de banco de dados do Amazon RDS, uma para clientes e outra para produtos. Para tanto, podemos inserir o trecho abaxaixo no nosso <strong>main.tf</strong>:</p>
<div class="highlight"><span class="filename">main.tf</span><pre><span></span><code><span class="c1"># Cria uma instância de banco de dados do Amazon RDS - Clientes(ID, Nome)</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_db_instance&quot;</span><span class="w"> </span><span class="nv">&quot;clients&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">engine</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mysql&quot;</span>
<span class="w">  </span><span class="na">identifier</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mysqlforlambdaterraformclients&quot;</span>
<span class="w">  </span><span class="na">allocated_storage</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">5</span>
<span class="w">  </span><span class="na">max_allocated_storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span>
<span class="w">  </span><span class="na">instance_class</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;db.t2.micro&quot;</span>
<span class="w">  </span><span class="na">publicly_accessible</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>

<span class="w">  </span><span class="na">db_name</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ExampleDB&quot;</span>
<span class="w">  </span><span class="na">username</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;admin&quot;</span>
<span class="w">  </span><span class="na">password</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;senhaDoBancoDeDados&quot;</span>
<span class="w">  </span><span class="na">skip_final_snapshot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>

<span class="w">  </span><span class="na">vpc_security_group_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">aws_default_security_group.default.id</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Cria uma outra instância de banco de dados do Amazon RDS - Produto(ID, Nome, Price)</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_db_instance&quot;</span><span class="w"> </span><span class="nv">&quot;products&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">engine</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mysql&quot;</span>
<span class="w">  </span><span class="na">identifier</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mysqlforlambdaterraformproducts&quot;</span>
<span class="w">  </span><span class="na">allocated_storage</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">5</span>
<span class="w">  </span><span class="na">max_allocated_storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span>
<span class="w">  </span><span class="na">instance_class</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;db.t2.micro&quot;</span>
<span class="w">  </span><span class="na">publicly_accessible</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>

<span class="w">  </span><span class="na">db_name</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ExampleDB&quot;</span>
<span class="w">  </span><span class="na">username</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;admin&quot;</span>
<span class="w">  </span><span class="na">password</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;senhaDoBancoDeDados&quot;</span>
<span class="w">  </span><span class="na">skip_final_snapshot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>

<span class="w">  </span><span class="na">vpc_security_group_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">aws_default_security_group.default.id</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<p><img alt="⚠️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/26a0.svg" title=":warning:" /> Você pode alterar o <strong>db_name</strong>, <strong>username</strong> e <strong>password</strong> pelos valores que você deseja para os seus banco de dados. <img alt="⚠️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/26a0.svg" title=":warning:" /></p>
<p>Agora, antes de criar sua função do Lambda, você deve criar um perfil de execução para dar à sua função as permissões necessárias. Para este roteiro, o Lambda precisa de permissão para gerenciar a conexão de rede com a Amazon VPC contendo sua instância de banco de dados, para pesquisar mensagens de uma fila do Amazon SQS e para criar grupos de logs, fluxos de logs e enviar eventos de logs. </p>
<p>Faremos isso pelo IAM. Vamos adicionar a criação no <strong>main.tf</strong>.</p>
<div class="highlight"><span class="filename">main.tf</span><pre><span></span><code><span class="c1"># Código já existente omitido</span>
<span class="c1"># ...</span>

<span class="c1"># Cria um perfil de execução de função</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_iam_role&quot;</span><span class="w"> </span><span class="nv">&quot;role&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;lambda-vpc-sqs-role-terraform&quot;</span>
<span class="w">  </span><span class="na">assume_role_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">jsonencode</span><span class="p">({</span>
<span class="w">    </span><span class="na">Version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;2012-10-17&quot;</span>
<span class="w">    </span><span class="na">Statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[{</span>
<span class="w">      </span><span class="na">Action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;sts:AssumeRole&quot;</span>
<span class="w">      </span><span class="na">Effect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span>
<span class="w">      </span><span class="nb">Principal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="na">Service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;lambda.amazonaws.com&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}]</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>

<span class="c1"># Cria uma policy </span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_iam_policy&quot;</span><span class="w"> </span><span class="nv">&quot;policy&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;necessary-policy&quot;</span>
<span class="w">  </span><span class="na">policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">jsonencode</span><span class="p">({</span>
<span class="w">    </span><span class="s2">&quot;Version&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;Statement&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;Sid&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;VisualEditor0&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;Effect&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;Action&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s2">&quot;ec2:CreateNetworkInterface&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;ec2:DescribeNetworkInterfaces&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;ec2:DeleteNetworkInterface&quot;</span>
<span class="w">        </span><span class="p">],</span>
<span class="w">        </span><span class="s2">&quot;Resource&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;*&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;Effect&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;Action&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s2">&quot;sqs:ReceiveMessage&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;sqs:DeleteMessage&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;sqs:GetQueueAttributes&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;sqs:SendMessage&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;sqs:GetQueueUrl&quot;</span>
<span class="w">        </span><span class="p">],</span>
<span class="w">        </span><span class="s2">&quot;Resource&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;*&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;Effect&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;Action&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s2">&quot;logs:CreateLogGroup&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;logs:CreateLogStream&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;logs:PutLogEvents&quot;</span>
<span class="w">        </span><span class="p">],</span>
<span class="w">        </span><span class="s2">&quot;Resource&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;arn:aws:logs:*:*:*&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>


<span class="c1">#associamos a policy à função IAM</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_iam_role_policy_attachment&quot;</span><span class="w"> </span><span class="nv">&quot;example&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">policy_arn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_iam_policy.policy.arn</span>
<span class="w">  </span><span class="na">role</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_iam_role.role.name</span>
<span class="p">}</span>
</code></pre></div>
<p>Vamos agora criar o pacote de implantação do Lambda.</p>
<p>Primeiramente, vamos criar uma pasta que servirá para a instalação da biblioca que usaremos no código Python e o arquivo em si, que serão compactados posteriormente.</p>
<p>Rode o comando abaixo no terminal para criar a pasta com o nome <strong>source_lambda</strong>:</p>
<p><div class="highlight"><pre><span></span><code>mkdir source_lambda 
</code></pre></div>
Agora, vamos instalar a biblioteca na pasta criada:</p>
<div class="highlight"><pre><span></span><code>pip install --target source_lambda pymysql
</code></pre></div>
<p>Feito isso, vamos criar o nosso código para a função Lambda.</p>
<p>O exemplo de código Python a seguir usa o pacote <a href="https://pymysql.readthedocs.io/en/latest/">PyMySQL</a> para abrir uma conexão com seu banco de dados. Na primeira vez que você invoca sua função, ela também cria uma nova tabela chamada Customer e uma chamada Product, cada uma em um DB. A primeira usa o seguinte esquema, em que CustID é a chave primária:</p>
<div class="highlight"><pre><span></span><code><span class="n">Customer</span><span class="p">(</span><span class="n">CustID</span><span class="p">,</span> <span class="n">Name</span><span class="p">)</span>
</code></pre></div>
<p>E a segunda usa o seguinte, onde ProdID é a chave primária:</p>
<div class="highlight"><pre><span></span><code><span class="n">Product</span> <span class="p">(</span><span class="n">ProdID</span><span class="p">,</span> <span class="n">Name</span><span class="p">,</span> <span class="n">Price</span><span class="p">)</span>
</code></pre></div>
<p>A função também usa a PyMySQL para adicionar registros a essa tabela. A função adiciona registros usando os IDs de clientes/produtos e nomes/e ou preços especificados nas mensagens que você adicionará à sua fila do Amazon SQS.</p>
<p>Observe que o código cria a conexão com seu banco de dados fora da função do manipulador. A criação da conexão no código de inicialização permite que a conexão seja reutilizada por invocações subsequentes de sua função e melhora o desempenho. </p>
<p>Adicione o novo trecho abaixo no seu <strong>main.tf</strong>:
<div class="highlight"><span class="filename">main.tf</span><pre><span></span><code><span class="c1"># Código já existente omitido</span>
<span class="c1"># ...</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;local_file&quot;</span><span class="w"> </span><span class="nv">&quot;python_script&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./source_lambda/lambda_function.py&quot;</span>
<span class="w">  </span><span class="na">content</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&lt;-</span><span class="dl">EOF</span>
<span class="sh">import sys</span>
<span class="sh">import logging</span>
<span class="sh">import pymysql</span>
<span class="sh">import json</span>

<span class="sh"># rds settings db clients</span>
<span class="sh">rds_host_clients  = &quot;${aws_db_instance.clients.endpoint}&quot;[:-5]</span>
<span class="sh">user_name_clients = &quot;admin&quot;</span>
<span class="sh">password_clients  = &quot;senhaDoBancoDeDados&quot;</span>
<span class="sh">db_name_clients   = &quot;ExampleDB&quot;</span>

<span class="sh"># rds settings db products</span>
<span class="sh">rds_host_products  = &quot;${aws_db_instance.products.endpoint}&quot;[:-5]</span>
<span class="sh">user_name_products = &quot;admin&quot;</span>
<span class="sh">password_products  = &quot;senhaDoBancoDeDados&quot;</span>
<span class="sh">db_name_products   = &quot;ExampleDB&quot;</span>


<span class="sh">logger = logging.getLogger()</span>
<span class="sh">logger.setLevel(logging.INFO)</span>

<span class="sh"># create the database connection outside of the handler to allow connections to be</span>
<span class="sh"># re-used by subsequent function invocations.</span>
<span class="sh">try:</span>
<span class="sh">    conn = pymysql.connect(host=rds_host_clients, user=user_name_clients, passwd=password_clients, db=db_name_clients, connect_timeout=5)</span>
<span class="sh">except pymysql.MySQLError as e:</span>
<span class="sh">    logger.error(&quot;ERROR: Unexpected error: Could not connect to MySQL instance - clients&quot;)</span>
<span class="sh">    logger.error(e)</span>
<span class="sh">    sys.exit()</span>

<span class="sh">logger.info(&quot;SUCCESS: Connection to RDS MySQL instance (clients) succeeded&quot;)</span>

<span class="sh">try:</span>
<span class="sh">    conn2 = pymysql.connect(host=rds_host_products, user=user_name_products, passwd=password_products, db=db_name_products, connect_timeout=5)</span>
<span class="sh">except pymysql.MySQLError as e:</span>
<span class="sh">    logger.error(&quot;ERROR: Unexpected error: Could not connect to MySQL instance - products&quot;)</span>
<span class="sh">    logger.error(e)</span>
<span class="sh">    sys.exit()</span>

<span class="sh">logger.info(&quot;SUCCESS: Connection to RDS MySQL instance (products) succeeded&quot;)</span>

<span class="sh">def lambda_handler(event, context):</span>
<span class="sh">    &quot;&quot;&quot;</span>
<span class="sh">    This function creates a new RDS database table and writes records to it</span>
<span class="sh">    &quot;&quot;&quot;</span>
<span class="sh">    message = event[&#39;Records&#39;][0][&#39;body&#39;]</span>
<span class="sh">    data = json.loads(message)</span>
<span class="sh">    #diferencia se é cliente ou produto</span>
<span class="sh">    if &#39;CustID&#39; in data:</span>
<span class="sh">        CustID = data[&#39;CustID&#39;]</span>
<span class="sh">        Name = data[&#39;Name&#39;]</span>

<span class="sh">        item_count = 0</span>
<span class="sh">        sql_string = f&quot;insert into Customer (CustID, Name) values({CustID}, &#39;{Name}&#39;)&quot;</span>

<span class="sh">        with conn.cursor() as cur:</span>
<span class="sh">            cur.execute(&quot;create table if not exists Customer ( CustID  int NOT NULL, Name varchar(255) NOT NULL, PRIMARY KEY (CustID))&quot;)</span>
<span class="sh">            cur.execute(sql_string)</span>
<span class="sh">            conn.commit()</span>
<span class="sh">            cur.execute(&quot;select * from Customer&quot;)</span>
<span class="sh">            logger.info(&quot;The following items have been added to the database clients:&quot;)</span>
<span class="sh">            for row in cur:</span>
<span class="sh">                item_count += 1</span>
<span class="sh">                logger.info(row)</span>
<span class="sh">        conn.commit()</span>

<span class="sh">        return &quot;Added %d items to RDS MySQL table&quot; %(item_count)</span>
<span class="sh">    else:</span>
<span class="sh">        ProdID = data[&#39;ProdID&#39;]</span>
<span class="sh">        Name = data[&#39;Name&#39;]</span>
<span class="sh">        Price = data[&#39;Price&#39;]</span>

<span class="sh">        item_count = 0</span>
<span class="sh">        sql_string = f&quot;insert into Product (ProdID, Name, Price) values({ProdID}, &#39;{Name}&#39;, {Price})&quot;</span>

<span class="sh">        with conn2.cursor() as cur:</span>
<span class="sh">        #price is float with two decimal places</span>
<span class="sh">            cur.execute(&quot;create table if not exists Product ( ProdID  int NOT NULL, Name varchar(255) NOT NULL, Price float(10,2) NOT NULL, PRIMARY KEY (ProdID))&quot;)</span>
<span class="sh">            cur.execute(sql_string)</span>
<span class="sh">            conn2.commit()</span>
<span class="sh">            cur.execute(&quot;select * from Product&quot;)</span>
<span class="sh">            logger.info(&quot;The following items have been added to the database products:&quot;)</span>
<span class="sh">            for row in cur:</span>
<span class="sh">                item_count += 1</span>
<span class="sh">                logger.info(row)</span>
<span class="sh">        conn2.commit()</span>

<span class="sh">        return &quot;Added %d items to RDS MySQL table&quot; %(item_count)</span>
<span class="dl">EOF</span>
<span class="p">}</span>
</code></pre></div></p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Repare que o "rds_host" é explicitamente dependente dos resources que criam os bancos de dados. 
Além disso, o slicing no final é feito pois a propriedade .endpoint retorna a porta ":3306", que a biblioteca pymsql já usa por padrão. </p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Use os valores de <strong>db_name</strong>, <strong>username</strong> e <strong>password</strong> pelos que você usou na criação dos databases.
Em produção, é recomendado não codificar esses dados em função, mas sim usar o <a href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/intro.html">AWS Secrets Manager</a> para armazenar com segurança as credenciais de acesso ao banco de dados.</p>
</div>
<p>Agora, temos tudo para criar o nosso <strong>.zip</strong> para a função Lambda:</p>
<div class="highlight"><span class="filename">main.tf</span><pre><span></span><code><span class="c1"># Código já existente omitido</span>
<span class="c1"># ...</span>

<span class="kr">data</span><span class="w"> </span><span class="nc">&quot;archive_file&quot;</span><span class="w"> </span><span class="nv">&quot;lambda_archive&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">depends_on</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">local_file.python_script</span><span class="p">]</span>
<span class="w">  </span><span class="na">source_dir</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./source_lambda&quot;</span>
<span class="w">  </span><span class="na">output_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;lambda_function.zip&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;zip&quot;</span>
<span class="p">}</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Repare que o <em>resource</em> "lambda_archive" é implicitamente dependente do <em>resource</em> que cria o arquivo .py. </p>
</div>
<p>Vamos criar nossa função Lambda. Fazemos isso por meio da inserção do resource abaixo:</p>
<div class="highlight"><span class="filename">main.tf</span><pre><span></span><code><span class="c1"># Código já existente omitido</span>
<span class="c1"># ...</span>

<span class="c1"># Cria a função Lambda</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_lambda_function&quot;</span><span class="w"> </span><span class="nv">&quot;test_lambda&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">filename</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;lambda_function.zip&quot;</span>
<span class="w">  </span><span class="na">function_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;LambdaFunctionWithRDS-terraform&quot;</span>
<span class="w">  </span><span class="na">role</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_iam_role.role.arn</span>
<span class="w">  </span><span class="na">handler</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;lambda_function.lambda_handler&quot;</span>
<span class="w">  </span><span class="na">runtime</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;python3.9&quot;</span>

<span class="w">  </span><span class="nb">vpc_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">subnet_ids</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_default_subnet.default</span><span class="p">[</span><span class="err">*</span><span class="p">].</span><span class="err">id</span>
<span class="w">    </span><span class="na">security_group_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">aws_default_security_group.default.id</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">data.archive_file.lambda_archive</span><span class="w"> </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Repare que o <em>resource</em> "test_lambda" é explicitamente dependente do resource que cria o arquivo <strong>.zip</strong>. </p>
</div>
<p>Agora iremos configurar a VPC padrão que é usada pelos bancos de dados e pelo Lambda.
Também as mesmas sub-redes para ambos.
Além disso, é preciso definir regra de entrada para a porta que os bancos de dados usam (:3306) e regra de saída (deixaremos todas).</p>
<div class="highlight"><span class="filename">main.tf</span><pre><span></span><code><span class="c1"># Código já existente omitido</span>
<span class="c1"># ...</span>


<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_default_subnet&quot;</span><span class="w"> </span><span class="nv">&quot;default&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="m">6</span>
<span class="w">  </span><span class="na">availability_zone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element</span><span class="p">([</span><span class="s2">&quot;us-east-1a&quot;, &quot;us-east-1b&quot;, &quot;us-east-1c&quot;, &quot;us-east-1d&quot;, &quot;us-east-1e&quot;, &quot;us-east-1f&quot;</span><span class="p">],</span><span class="w"> </span><span class="nv">count.index</span><span class="p">)</span>

<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_default_security_group&quot;</span><span class="w"> </span><span class="nv">&quot;default&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">vpc_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_default_vpc.default.id</span>

<span class="w">  </span><span class="nb">ingress</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">from_port</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="m">3306</span>
<span class="w">    </span><span class="na">to_port</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">3306</span>
<span class="w">    </span><span class="na">protocol</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;tcp&quot;</span>
<span class="w">    </span><span class="na">cidr_blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;0.0.0.0/0&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">egress</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">from_port</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="na">to_port</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="na">protocol</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;-1&quot;</span>
<span class="w">    </span><span class="na">cidr_blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;0.0.0.0/0&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>

<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_default_vpc&quot;</span><span class="w"> </span><span class="nv">&quot;default&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>
</code></pre></div>
<p>Agora você deve criar a fila do Amazon SQS que usará para invocar sua função do Lambda:</p>
<div class="highlight"><span class="filename">main.tf</span><pre><span></span><code><span class="c1"># Código já existente omitido</span>
<span class="c1"># ...</span>

<span class="c1"># Cria uma fila do Amazon SQS</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_sqs_queue&quot;</span><span class="w"> </span><span class="nv">&quot;my_queue&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;LambdaRDSQueue&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>Agora, iremos criar um <a href="https://docs.aws.amazon.com/lambda/latest/dg/invocation-eventsourcemapping.html">mapeamento da origem do evento</a> para invocar sua função do Lambda. </p>
<p>Um mapeamento da origem do evento é um recurso no Lambda que lê itens de um fluxo ou de uma fila e invoca uma função do Lambda. Ao configurar um mapeamento da origem do evento, você pode especificar um tamanho de lote para que os registros do seu fluxo ou da sua fila sejam agrupados em uma única carga útil. Neste exemplo, definiremos o tamanho do lote como 1 para que a função do Lambda seja invocada toda vez que você enviar uma mensagem para sua fila.</p>
<div class="highlight"><span class="filename">main.tf</span><pre><span></span><code><span class="c1"># Código já existente omitido</span>
<span class="c1"># ...</span>

<span class="c1"># Cria um mapeamento da origem do evento para invocar sua função do Lambda</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_lambda_event_source_mapping&quot;</span><span class="w"> </span><span class="nv">&quot;resource_queue&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">event_source_arn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_sqs_queue.my_queue.arn</span>
<span class="w">  </span><span class="na">function_name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_lambda_function.test_lambda.function_name</span>
<span class="w">  </span><span class="na">batch_size</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<span class="p">}</span>
</code></pre></div>
<p>Precisamos agora criar um sistema para notificar um determinado e-mail quando um registro for inserido no banco de dados.</p>
<p>Para isso, faremos uso do SNS, que pode enviar notificações de diferentes modos. Utilizaremos o <strong>e-mail</strong> nesse roteiro.
Vamos, então, configurá-lo. </p>
<p>Para isso, adicione, no main.tf, o seguinte código:</p>
<div class="highlight"><span class="filename">main.tf</span><pre><span></span><code><span class="c1"># Código já existente omitido</span>
<span class="c1"># ...</span>
<span class="c1">#Criando um tópico de notificações no SNS</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_sns_topic&quot;</span><span class="w"> </span><span class="nv">&quot;sns_topic&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;LambdaRDSTopic&quot;</span>
<span class="p">}</span>

<span class="c1">#variavel email_subscription</span>
<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;email&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="na">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;email_padrao@gmail.com&quot;</span>
<span class="p">}</span>

<span class="c1">#Criando uma assinatura no tópico</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_sns_topic_subscription&quot;</span><span class="w"> </span><span class="nv">&quot;sns_topic_subscription&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">topic_arn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_sns_topic.sns_topic.arn</span>
<span class="w">  </span><span class="na">protocol</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;email&quot;</span>
<span class="w">  </span><span class="na">endpoint</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.email</span>
<span class="p">}</span>
</code></pre></div>
<p>Vamos agora criar um alarme no Cloudwatch. Ele será o responsável por conectar a geração de logs da nossa função que insere dados nos bancos de dados ao SNS, que notificará o usuário via e-mail.</p>
<p>O alarme que criaremos recebe o ARN do tópico que irá gerar a notificação, filtra o log específico da função Lambda e muda de estado (de OK para ALARM) conforme surgir log.</p>
<p>Para fazer isso, adicionaremos o trecho abaixo no nosso código:</p>
<div class="highlight"><span class="filename">main.tf</span><pre><span></span><code><span class="c1">#Criando uma notificação para o tópico</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_cloudwatch_log_metric_filter&quot;</span><span class="w"> </span><span class="nv">&quot;lambda_log_filter&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;LambdaRDSLogFilter&quot;</span>
<span class="w">  </span><span class="na">pattern</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ERROR&quot;</span>
<span class="w">  </span><span class="na">log_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/aws/lambda/LambdaFunctionWithRDS-terraform&quot;</span>
<span class="w">  </span><span class="nb">metric_transformation</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ErrorCount&quot;</span>
<span class="w">    </span><span class="na">namespace</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Custom/CloudWatchLogs&quot;</span>
<span class="w">    </span><span class="na">value</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1&quot;</span>
<span class="w">    </span><span class="na">default_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_cloudwatch_metric_alarm&quot;</span><span class="w"> </span><span class="nv">&quot;lambda_log_alarm&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">alarm_name</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;lambda-log-alarm&quot;</span>
<span class="w">  </span><span class="na">alarm_description</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Alarm triggered on CloudWatch Logs&quot;</span>
<span class="w">  </span><span class="na">comparison_operator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;GreaterThanOrEqualToThreshold&quot;</span>
<span class="w">  </span><span class="na">evaluation_periods</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1&quot;</span>
<span class="w">  </span><span class="na">metric_name</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ErrorCount&quot;</span>
<span class="w">  </span><span class="na">namespace</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Custom/CloudWatchLogs&quot;</span>
<span class="w">  </span><span class="na">period</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;60&quot;</span>
<span class="w">  </span><span class="na">statistic</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;SampleCount&quot;</span>
<span class="w">  </span><span class="na">threshold</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1&quot;</span>
<span class="w">  </span><span class="na">alarm_actions</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">aws_sns_topic.sns_topic.arn</span><span class="p">]</span>
<span class="w">  </span><span class="na">treat_missing_data</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;missing&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>Agora temos tudo para efetivamente usar o <em>Terraform</em> para criar nossa infraestrutura definida em código. </p>
<p>Para isso, certifique-se que você está com o terminal na pasta <strong>terraform</strong>.</p>
<p>Então, criamos variáveis de ambiente com a chave que criamos no início:</p>
<p><div class="highlight"><pre><span></span><code>export AWS_ACCESS_KEY_ID=&lt;ID_CHAVE_DE_ACESSO&gt;
export AWS_SECRET_ACCESS_KEY=&lt;CHAVE_SECRETA_DE_ACESSO&gt;
</code></pre></div>
Esse procedimento evita a exposição da senha.</p>
<p>Também vamos exportar a região padrão, que nesse roteiro é "us-east-1":</p>
<div class="highlight"><pre><span></span><code>export AWS_DEFAULT_REGION=&quot;us-east-1&quot;
</code></pre></div>
<p>Após isso, vamos iniciar os recursos terraform necessários para provisionar rodando o comando abaixo:</p>
<div class="highlight"><pre><span></span><code>terraform init
</code></pre></div>
<p>Agora veremos o plano de criação desses recursos:
<div class="highlight"><pre><span></span><code>terraform plan
</code></pre></div></p>
<p>Por fim, realize deploy dos recursos na nuvem:
<div class="highlight"><pre><span></span><code>terraform apply -var=&quot;email=seu_email@gmail.com&quot; -auto-approve
</code></pre></div></p>
<p>Em torno de alguns minutos, se tudo der certo, sua infraestrutura estará criada.</p>
<p>O e-mail cadastrado precisa confirmar que deseja receber notificações:
<img alt="" src="email.png" /></p>
<p>Você pode verificar que o de banco de dados foi criado acessando este <a href="https://us-east-1.console.aws.amazon.com/rds/home?region=us-east-1#databases:">link</a>. O esperado é algo como na imagem abaixo:
<img alt="" src="db.png" /></p>
<p>A função do IAM criada pode ser visualizada <a href="https://us-east-1.console.aws.amazon.com/iamv2/home?region=us-east-1#/roles">aqui</a>. Ela possui as permissões definidas. 
O esperado é algo como na imagem abaixo:
<img alt="" src="iamrole.png" /></p>
<p>Podemos conferir nossa função Lambda <a href="https://us-east-1.console.aws.amazon.com/lambda/home?region=us-east-1#/functions">aqui</a>.O esperado é algo como na imagem abaixo:
<img alt="" src="lambda.png" /></p>
<p>E nossa fila do SQS pode ser acessada <a href="https://us-east-1.console.aws.amazon.com/sqs/v2/home?region=us-east-1#/queues">aqui</a>. O esperado é algo como na imagem abaixo:
<img alt="" src="sqs.png" /></p>
<p>O tópico SNS <a href="https://us-east-1.console.aws.amazon.com/sns/v3/home?region=us-east-1#/topics">aqui</a>
O esperado é algo como na imagem abaixo:
<img alt="" src="sns.png" /></p>
<p>E o alarme <a href="https://us-east-1.console.aws.amazon.com/cloudwatch/home?region=us-east-1#alarmsV2:">aqui</a>. 
O esperado é algo como na imagem abaixo:
<img alt="" src="alarme.png" /></p>
<h2 id="testando-e-monitorando-a-infraestrutura">Testando e monitorando a infraestrutura<a class="headerlink" href="#testando-e-monitorando-a-infraestrutura" title="Permanent link">&para;</a></h2>
<p>Para testar sua configuração completa, adicione mensagens à sua fila do Amazon SQS usando o console.
Siga os passos abaixo:</p>
<ul>
<li>
<p>Abra a <a href="https://us-east-1.console.aws.amazon.com/sqs/v2/home?region=us-east-1#/queues">página Filas</a> do console do Amazon SQS e selecione sua fila <code>(LambdaRDSQueue)</code>.</p>
</li>
<li>
<p>Escolha <strong>Enviar e receber mensagens</strong> e cole o JSON a seguir (exemplo de um cliente) no <strong>Corpo da mensagem</strong> no painel <strong>Enviar mensagem</strong>.</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;CustID&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">404</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;Name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Rodolfo Avelino&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p><img alt="" src="sendMessage.png" /></p>
</li>
<li>
<p>Escolha <strong>Send Message (Enviar mensagem)</strong>. Essa ação fará com que o Lambda invoque sua função por meio do mapeamento da origem do evento. </p>
</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Se quiser testar com um produto, use o JSON abaixo:
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;ProdID&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">404</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;Name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Router&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;Price&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">99.98</span>
<span class="p">}</span>
</code></pre></div></p>
</div>
<p>Para confirmar que o Lambda invocou sua função conforme o esperado, usaremos o CloudWatch Logs para verificar se a função gravou o nome e o ID do cliente na tabela do seu banco de dados, por meio do grupo de logs criado pela função Lambda. Para isso, siga os passos abaixo:</p>
<ul>
<li>
<p>Abra a página <a href="https://console.aws.amazon.com/cloudwatch/home#logsV2:log-groups">Grupos de logs</a> do console do CloudWatch e selecione o grupo de logs para sua função <code>(aws/lambda/LambdaFunctionWithRDS-terraform)</code>.</p>
</li>
<li>
<p>No painel <strong>Fluxos de logs</strong>, escolha o fluxo de logs mais recente.</p>
</li>
</ul>
<p>Sua tabela deve conter um registro de cliente, pois houve uma invocação da sua função. No fluxo de logs, você deverá ver mensagens semelhantes às seguintes:</p>
<div class="highlight"><pre><span></span><code>    [INFO]  The following items have been added to the database clients:
    [INFO] (404, &#39;Rodolfo Avelino&#39;)
</code></pre></div>
<p><img alt="" src="log.png" /></p>
<p>Você também deve ter recebido, ou receberá em poucos minutos, um e-mail com notificação do Alarme, como no exemplo abaixo:</p>
<p><img alt="" src="email2.png" /></p>
<h2 id="excluindo-a-infraestrutura">Excluindo a infraestrutura<a class="headerlink" href="#excluindo-a-infraestrutura" title="Permanent link">&para;</a></h2>
<p>Para excluir os recursos criados para este roteiro, basta executar o comando abaixo:</p>
<div class="highlight"><pre><span></span><code>terraform destroy -auto-approve
</code></pre></div>
<h2 id="referencias">Referências<a class="headerlink" href="#referencias" title="Permanent link">&para;</a></h2>
<p><a href="https://docs.aws.amazon.com/lambda/latest/dg/services-rds-tutorial.html#w122aac77d191c13c39">AWS Documentation</a></p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023 / Lorran Caetano Machado Lopes / lorrancml@al.insper.edu.br
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": ".", "features": ["instant", "navigation.expand", {"tabs": true}], "search": "assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="assets/javascripts/bundle.b4d07000.min.js"></script>
      
    
  </body>
</html>